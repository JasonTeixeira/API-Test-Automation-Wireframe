name: API Test Automation CI/CD

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:
  schedule:
    - cron: '0 0 * * *'  # Daily at midnight

env:
  PYTHON_VERSION: '3.11'
  API_BASE_URL: 'https://reqres.in/api'

jobs:
  code-quality:
    name: Code Quality Checks
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: Run Black formatter check
        run: |
          black --check --diff .
        continue-on-error: true
      
      - name: Run isort import check
        run: |
          isort --check-only --diff .
        continue-on-error: true
      
      - name: Run pylint
        run: |
          pylint clients/ models/ utils/ config/ --fail-under=8.0
        continue-on-error: true
      
      - name: Run mypy type checking
        run: |
          mypy clients/ models/ utils/ config/ --ignore-missing-imports
        continue-on-error: true

  smoke-tests:
    name: Smoke Tests (Fast Feedback)
    runs-on: ubuntu-latest
    needs: code-quality
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: Run smoke tests
        run: |
          pytest tests/ -m smoke -v --tb=short \
            --html=reports/smoke-report.html --self-contained-html
        env:
          API_BASE_URL: ${{ env.API_BASE_URL }}
      
      - name: Upload smoke test report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: smoke-test-report
          path: reports/smoke-report.html
          retention-days: 30

  api-tests:
    name: API Tests - ${{ matrix.test-suite }}
    runs-on: ubuntu-latest
    needs: smoke-tests
    strategy:
      fail-fast: false
      matrix:
        test-suite: 
          - users
          - resources
          - auth
          - workflows
          - negative
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: Run ${{ matrix.test-suite }} tests
        run: |
          pytest tests/${{ matrix.test-suite }}/ -v --tb=short \
            --html=reports/${{ matrix.test-suite }}-report.html \
            --self-contained-html \
            --alluredir=reports/allure-results
        env:
          API_BASE_URL: ${{ env.API_BASE_URL }}
      
      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.test-suite }}-test-results
          path: |
            reports/${{ matrix.test-suite }}-report.html
            reports/allure-results
          retention-days: 30

  parallel-tests:
    name: Parallel Test Execution
    runs-on: ubuntu-latest
    needs: code-quality
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: Run all tests in parallel
        run: |
          pytest tests/ -n 4 -v --tb=short \
            --html=reports/parallel-report.html \
            --self-contained-html \
            --alluredir=reports/allure-results
        env:
          API_BASE_URL: ${{ env.API_BASE_URL }}
      
      - name: Upload parallel test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: parallel-test-results
          path: |
            reports/parallel-report.html
            reports/allure-results
          retention-days: 30

  coverage:
    name: Code Coverage Analysis
    runs-on: ubuntu-latest
    needs: code-quality
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: Run tests with coverage
        run: |
          pytest tests/ -v \
            --cov=clients --cov=models --cov=utils --cov=config \
            --cov-report=html --cov-report=term --cov-report=xml
        env:
          API_BASE_URL: ${{ env.API_BASE_URL }}
      
      - name: Upload coverage report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: |
            htmlcov/
            coverage.xml
          retention-days: 30
      
      - name: Coverage comment
        if: github.event_name == 'pull_request'
        uses: py-cov-action/python-coverage-comment-action@v3
        with:
          GITHUB_TOKEN: ${{ github.token }}
        continue-on-error: true

  allure-report:
    name: Generate Allure Report
    runs-on: ubuntu-latest
    needs: [api-tests, parallel-tests]
    if: always()
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Download all test results
        uses: actions/download-artifact@v4
        with:
          path: artifacts
      
      - name: Merge allure results
        run: |
          mkdir -p allure-results
          find artifacts -name "allure-results" -type d -exec cp -r {}/* allure-results/ \;
      
      - name: Generate Allure report
        uses: simple-elf/allure-report-action@master
        if: always()
        with:
          allure_results: allure-results
          allure_report: allure-report
          gh_pages: gh-pages
          allure_history: allure-history
      
      - name: Deploy Allure report to GitHub Pages
        if: github.ref == 'refs/heads/main' && always()
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_branch: gh-pages
          publish_dir: allure-history

  regression-suite:
    name: Full Regression Suite
    runs-on: ubuntu-latest
    needs: smoke-tests
    if: github.event_name == 'schedule' || github.event_name == 'workflow_dispatch'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: Run full regression suite
        run: |
          pytest tests/ -m regression -v --tb=short \
            --html=reports/regression-report.html \
            --self-contained-html \
            --alluredir=reports/allure-results
        env:
          API_BASE_URL: ${{ env.API_BASE_URL }}
      
      - name: Upload regression results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: regression-test-results
          path: |
            reports/regression-report.html
            reports/allure-results
          retention-days: 90

  security-tests:
    name: Security Tests
    runs-on: ubuntu-latest
    needs: code-quality
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: Run security tests
        run: |
          pytest tests/ -m security -v --tb=short \
            --html=reports/security-report.html \
            --self-contained-html
        env:
          API_BASE_URL: ${{ env.API_BASE_URL }}
      
      - name: Upload security test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: security-test-results
          path: reports/security-report.html
          retention-days: 30

  notify:
    name: Notify Results
    runs-on: ubuntu-latest
    needs: [smoke-tests, api-tests, parallel-tests, coverage]
    if: always()
    
    steps:
      - name: Check test results
        id: test-results
        run: |
          if [ "${{ needs.smoke-tests.result }}" == "success" ] && \
             [ "${{ needs.api-tests.result }}" == "success" ] && \
             [ "${{ needs.parallel-tests.result }}" == "success" ]; then
            echo "status=success" >> $GITHUB_OUTPUT
          else
            echo "status=failure" >> $GITHUB_OUTPUT
          fi
      
      - name: Test Summary
        run: |
          echo "## Test Results Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Job | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Code Quality | ${{ needs.code-quality.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Smoke Tests | ${{ needs.smoke-tests.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| API Tests | ${{ needs.api-tests.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Parallel Tests | ${{ needs.parallel-tests.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Coverage | ${{ needs.coverage.result }} |" >> $GITHUB_STEP_SUMMARY
